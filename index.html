<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="crt.css">
     <!-- <style></style> -->
</head>

<body id="mainC">
    <div class="phosphorsContainer">
        <div class="flicker" style="display: none;"></div>
        <div class="rgb" >
            <div class="scanlines RGB-bloom" style="display: none"> </div>
        </div>

        <div class="red">
            <div class="scanlines R "> </div>
        </div>

        <div class="green">
            <div class="scanlines G "> </div>
        </div>

        <div class="blue">
            <div class="scanlines B"> </div>
        </div>

        <div class="mask"></div>

    </div>
    <!-- <div class="test-image crt"></div> -->
    <main class="container crt" >
    <div class="inner">

    <svg id="leftEye" class="eye" xmlns="http://www.w3.org/2000/svg" width="90" height="90">
        <g transform="translate(-20.386929,-58.69985)">
            <path id="base"
                d="m 24.033694,42.910544 c 0,0 3.861997,22.636977 4.96766,29.773434 0.04998,7.960063 2.369779,5.188203 5.067999,8.717334 -1.04e-4,19.739818 10.829373,35.742138 24.188187,35.742008 13.358815,1.3e-4 24.188292,-16.00219 24.188188,-35.742008 C 82.444761,62.501008 59.663184,58.974883 46.895849,57.833481 Z" />
            <path id="angry"
                d="m 20.386929,58.699849 c 0,0 6.920263,12.36902 11.89595,17.251168 7.409839,2.454378 4.773567,8.658243 5.067999,8.717334 -1.04e-4,19.739819 9.720707,7.455153 23.375215,7.175406 14.769732,3.286602 26.398689,16.989683 25.00116,-7.175406 C 85.726286,65.768047 62.944709,62.241922 50.177374,61.10052 Z" />
            <path id="shock"
                d=" m 37.50625,37.378584 c 0,0 -9.610581,28.168902 -8.504919,35.305352 0.04998,7.960055 2.36969,5.188169 5.067907,8.717297 -1.04e-4,19.739797 10.829387,35.742137 24.188188,35.742007 13.358802,1.3e-4 24.188292,-16.00221 24.188188,-35.742007 C 82.444647,62.500948 59.663168,58.97508 46.895846,57.833679 Z m 20.169816,28.750713 c 7.310564,-0.06866 21.651655,5.396519 20.146057,21.786784 -1.114183,12.129249 -11.551011,24.046589 -18.861898,24.046589 -7.310886,0 -17.792326,-9.5752 -18.055228,-21.752672 -0.437184,-20.250054 6.407989,-23.983379 16.771069,-24.080701 z " />
            <path id="blank"
                d="" />
            <path id="x"
       d="m 28.701787,48.684227 c 0,0 14.211747,25.917108 21.110097,36.294428 0,0 0.242645,0.280249 -0.624535,0.119613 -26.07921,32.921622 -29.070942,36.140472 4.718098,3.562249 31.883787,30.145513 28.989451,30.279663 5.103454,-5.439411 16.979765,-40.767437 25.28712,-50.960815 -4.755429,-3.442943 z"
     />

        </g>
    </svg>
    </div>
</main>
    <div id="controls">
        <button class="emote" data-emotion="base">o o</button>
        <button class="emote" data-emotion="angry">^ ^</button>
        <button class="emote" data-emotion="shock">O O</button>
        <!-- <button class="emote" data-emotion="blank">fnord</button> -->
        <button class="emote" data-emotion="x">X X</button>
        <button class="hideControls" >hide</button>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://unpkg.com/flubber@0.3.0"></script>
    <script src="script.js"></script>
    <script>
        $('.hideControls').click(function(){
            $('#controls').hide("slow").then().addClass("hidden");
        })
        $('.inner').on('click','#rightEye',function(e){
            console.log("A")
            changeTo(emotions.random.Get());
        });
        $('#leftEye').on("dblclick",function(e){
            $("#controls").toggleClass("hidden")
            fullscreen()
        })
        var emotions = { list: {}, array: [],
        default:"base",
        blink:{
            check:function(){
                console.log(this.list,emotions.current)
                this.enabled = $.inArray(emotions.current, this.list) != -1 
                return this.enabled;
            },
            enabled:true,
            list:["base"]
        },
        random:{
            enabled:false,
            list:["base","angry","shock"],
            Get:function(){
                let n = this.list[Math.floor(Math.random()*this.list.length)]
                if(n==emotions.current){
                    return this.Get()
                }else{
                    return n;
                }
            }
        } };
        emotions.current = emotions.default;
        // emotions.blinkList=["base"];
        // emotions.blink=true;
        // emotions.random=true;
        var rawEmotes = [...document.querySelectorAll("path")];
        rawEmotes.forEach(obj => {
            let id = obj.getAttribute("id");
            emotions.list[id] = { d: obj.getAttribute("d") };
            emotions.array.push(id);
        })
        // Remove all the paths except the first
        d3.selectAll("path")
            .filter(function (d, i) { return i; })
            .remove();

        d3.select("path")
            .style("display", "block")

        let changeTo = function(emotion,eye='both'){
            let eyes={left:['#leftEye'],right:['#rightEye'],both:['#leftEye','#rightEye']}

            console.log(emotion)
            animate(eyes[eye],emotion)
        }
        $(".emote").click(function(){
            let emotion = $(this).attr("data-emotion")
            animate(['#leftEye','#rightEye'],emotion)
        })


        rightEye = $("#leftEye").clone().attr("id","rightEye");
        $(".inner").append(rightEye)
        function animate(selectors, target) {
            var start = emotions.list[emotions.current].d
            end = emotions.list[target].d
            emotions.current = target;
            emotions.blink.check();// = $.inArray(emotions.current,emotions.blinkList)!=-1 
            d3
                .select(".inner")
                .selectAll("path")
                .datum({ start, end })
                .transition()
                .duration(1500)
                .ease(d3.easeElasticInOut)
                .attrTween("d", function (d) {
                    return flubber.interpolate(d.start, d.end, { maxSegmentLength: 2.1 })
                })
            // .on("end", function() {
            //   sel.call(animate);
            // });
        }
        
        
        let tim=0;
        let cycles = 0;
        
        const t = d3.interval((elapsed) => {
            if(emotions.blink.enabled){
                if(tim>70)$('.container:not(.blink)').addClass("blink");
                if(tim<=5)$('.container.blink').removeClass("blink");//
            }
            tim++
            ti = Math.floor(tim/2)
            if(ti>20)e=20-(ti-20)
            else e=ti
            // if(tim<0)tim=1-tim
            // console.log(e);
            maskOpacity(e/100+0.1)
            changeOpacity(e/120+0.1) 
            if (tim >= 80){
                tim = 0;
                cycles++;
                if (cycles % 2 == 0 && emotions.random.enabled) {
                    let ran = emotions.random.Get();
                    console.log("random", ran)
                    changeTo(ran);
                }
            }
        }, 150);

        function fullscreen() {
    var isInFullScreen = (document.fullscreenElement && document.fullscreenElement !== null) ||
        (document.webkitFullscreenElement && document.webkitFullscreenElement !== null) ||
        (document.mozFullScreenElement && document.mozFullScreenElement !== null) ||
        (document.msFullscreenElement && document.msFullscreenElement !== null);

    var docElm = document.documentElement;
    if (!isInFullScreen) {
        if (docElm.requestFullscreen) {
            docElm.requestFullscreen();
        } else if (docElm.mozRequestFullScreen) {
            docElm.mozRequestFullScreen();
        } else if (docElm.webkitRequestFullScreen) {
            docElm.webkitRequestFullScreen();
        } else if (docElm.msRequestFullscreen) {
            docElm.msRequestFullscreen();
        }
    } else {
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
    }
}
    </script>